<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ã®·ãê·â¢·ã≠ ·åæ·àù ·àò·äï·çà·à≥·ãä ·åâ·ãû</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Ethiopic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --maroon: #4a0404; --gold: #d4af37; }
        body { font-family: 'Noto Serif Ethiopic', serif; background-color: var(--maroon); color: white; margin: 0; overflow-x: hidden; }
        .parchment { background-color: #fdf6e3; color: #2c241b; border-left: 8px solid var(--gold); }
        .zigzag-line { position: absolute; width: 4px; background: rgba(212, 175, 55, 0.2); left: 50%; transform: translateX(-50%); z-index: 0; }
        .node-btn { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); background: white; color: var(--maroon); font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; cursor: pointer; z-index: 10; font-size: 13px; }
        .node-btn:hover { transform: scale(1.1); background: var(--gold); color: white; }
        .hidden { display: none !important; }
        .tab-active { color: var(--gold); border-bottom: 3px solid var(--gold); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--maroon); }
        ::-webkit-scrollbar-thumb { background: #8a1c1c; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        /* Form Styles */
        input, select, textarea { 
            color: #000000 !important; 
            background-color: #ffffff !important; 
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.5);
        }

        /* Toast Notification */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; pointer-events: none;
        }
        .toast {
            background: rgba(255, 255, 255, 0.95);
            color: #4a0404;
            padding: 12px 24px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
            border-left: 5px solid var(--gold);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- AUTH VIEW -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-6 text-center relative">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" style="background-image: radial-gradient(#d4af37 1px, transparent 1px); background-size: 20px 20px;"></div>

        <div class="w-full max-w-sm bg-black/40 backdrop-blur-md p-8 rounded-3xl border border-yellow-900/50 shadow-2xl relative z-10">
            
            <!-- LOGO SECTION -->
            <div class="flex justify-center mb-6">
                <!-- Replace 'src' below with your own image URL (e.g., 'logo.png') -->
                <img src="abiytsom.png"
                     alt="App Logo" 
                     class="h-25 w-40 object-contain drop-shadow-xl bg-brown ">
            </div>

            <h1 class="text-3xl font-bold mb-6 text-yellow-500">·ã®·ãê·â¢·ã≠ ·åæ·àù ·åâ·ãû</h1>
            
            <div class="flex mb-6 bg-black/30 rounded-xl p-1">
                <button onclick="switchAuthTab('login')" id="tab-btn-login" class="flex-1 py-2 rounded-lg text-sm font-bold transition bg-[#4a0404] text-white">·åç·â£</button>
                <button onclick="switchAuthTab('signup')" id="tab-btn-signup" class="flex-1 py-2 rounded-lg text-sm font-bold transition text-gray-400">·àò·ãù·åç·â•</button>
            </div>

            <!-- Login Form -->
            <div id="form-login" class="space-y-4 fade-in">
                <div class="text-left space-y-1">
                    <label class="text-xs text-yellow-500 font-bold ml-1">·ä¢·àú·ã≠·àç</label>
                    <input type="email" id="login-email" placeholder="email@example.com" class="w-full p-3 rounded-xl outline-none">
                </div>
                <div class="text-left space-y-1">
                    <label class="text-xs text-yellow-500 font-bold ml-1">·ã®·ã≠·àà·çç ·âÉ·àç</label>
                    <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 rounded-xl outline-none">
                </div>
                <button onclick="handleLogin()" class="w-full bg-white text-[#4a0404] py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-yellow-50 transition active:scale-95">·åç·â£</button>
            </div>

            <!-- Signup Form -->
            <div id="form-signup" class="hidden space-y-4 fade-in">
                <div class="text-left space-y-1">
                    <label class="text-xs text-yellow-500 font-bold ml-1">·ã®·â∞·å†·âÉ·àö ·àµ·àù</label>
                    <input type="text" id="signup-username" placeholder="·àà·àù·à≥·àå: Alemu" class="w-full p-3 rounded-xl outline-none">
                </div>
                <div class="text-left space-y-1">
                    <label class="text-xs text-yellow-500 font-bold ml-1">·ä¢·àú·ã≠·àç</label>
                    <input type="email" id="signup-email" placeholder="email@example.com" class="w-full p-3 rounded-xl outline-none">
                </div>
                <div class="text-left space-y-1">
                    <label class="text-xs text-yellow-500 font-bold ml-1">·ã®·ã≠·àà·çç ·âÉ·àç</label>
                    <input type="password" id="signup-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 rounded-xl outline-none">
                </div>
                <div class="text-left space-y-1">
                    <label class="text-xs text-yellow-500 font-bold ml-1">·ã´·à®·åã·åç·å°</label>
                    <input type="password" id="signup-confirm-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 rounded-xl outline-none">
                </div>
                <button onclick="handleSignup()" class="w-full bg-yellow-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-yellow-500 transition active:scale-95">·àò·ãù·åç·â•</button>
            </div>
        </div>
    </div>

    <!-- SETUP VIEW -->
    <div id="setup-view" class="hidden min-h-screen flex flex-col items-center justify-center p-6 text-center relative">
         <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" style="background-image: radial-gradient(#d4af37 1px, transparent 1px); background-size: 20px 20px;"></div>
         <div class="w-full max-w-sm space-y-6 z-10 fade-in">
            <div class="w-20 h-20 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-yellow-500"><span class="text-3xl">‚úùÔ∏è</span></div>
            <h2 class="text-2xl font-bold">·ä•·äï·ä≥·äï ·ã∞·àÖ·äì ·àò·å°</h2>
            <p class="text-white/70 text-sm">·åâ·ãû·ãç·äï ·àà·àò·åÄ·àò·à≠ ·ä•·â£·ä≠·ãé ·àô·àâ ·àµ·àù·ãé·äï ·ã´·àµ·åà·â°</p>
            <input type="text" id="user-display-name" placeholder="·àô·àâ ·àµ·àù" class="w-full p-5 rounded-2xl outline-none focus:ring-4 ring-yellow-600/50 shadow-lg text-xl text-center font-bold">
            <button onclick="handleProfileSetup()" class="w-full bg-white text-[#4a0404] py-4 rounded-2xl font-bold text-xl shadow-2xl active:scale-95 transition border-b-4 border-yellow-600 hover:border-yellow-500">·åâ·ãû·ãç·äï ·åÄ·àù·à≠</button>
            <button onclick="handleLogout()" class="text-xs text-white/40 hover:text-white underline mt-4">·ãç·å£</button>
        </div>
    </div>

    <!-- MAIN APP VIEW -->
    <div id="app-view" class="hidden flex flex-col min-h-screen">
        <header class="p-4 bg-black/40 border-b border-yellow-900 sticky top-0 z-50 backdrop-blur-md flex justify-between items-center shadow-lg">
            <div>
                <h1 class="text-lg font-bold text-white">·ã®·ãê·â¢·ã≠ ·åæ·àù ·åâ·ãû</h1>
                <span id="display-user" class="text-[10px] text-yellow-500 font-bold block"></span>
            </div>
            <button onclick="handleLogout()" class="bg-red-900/40 border border-red-500 text-red-200 px-3 py-1 rounded-lg text-xs hover:bg-red-800 transition flex items-center gap-1"><span>·ãç·å£</span></button>
        </header>

        <nav class="flex justify-around bg-black/20 border-b border-yellow-900/30 sticky top-[60px] z-40 backdrop-blur-sm">
            <button onclick="switchTab('journey')" id="btn-journey" class="p-4 font-bold tab-active text-sm">·åâ·ãû</button>
            <button onclick="switchTab('creative')" id="btn-creative" class="p-4 font-bold text-gray-400 text-sm">·àò·ãµ·à®·ä≠</button>
            <button onclick="switchTab('admin')" id="btn-admin" class="hidden p-4 font-bold text-gray-400 text-sm">·ä†·ãµ·àö·äï</button>
        </nav>

        <main class="flex-grow p-4 relative">
            
            <!-- Tab: Journey -->
            <div id="tab-journey" class="max-w-md mx-auto">
                <div id="view-weeks" class="relative py-8">
                    <div class="zigzag-line h-full"></div>
                    <div id="weeks-container" class="space-y-12 relative"></div>
                </div>
                <div id="view-days" class="hidden relative py-8">
                    <button onclick="showWeeks()" class="mb-4 text-yellow-500 font-bold flex items-center gap-1 hover:text-white transition">‚Üê ·â∞·àò·àà·àµ</button>
                    <div class="zigzag-line h-[85%]"></div>
                    <div id="days-container" class="space-y-12 relative"></div>
                </div>
            </div>

            <!-- Tab: Creative -->
            <div id="tab-creative" class="hidden max-w-lg mx-auto space-y-6 pb-20">
                <div class="bg-white/10 p-4 rounded-2xl border border-white/5">
                    <h3 class="font-bold mb-3 text-yellow-500">·ä†·ã≤·àµ ·àÉ·à≥·â• ·ã´·åã·à©</h3>
                    <select id="post-category" class="w-full mb-3 p-3 rounded-lg font-bold">
                        <option value="·åç·å•·àù">·åç·å•·àù</option>
                        <option value="·â≥·à™·ä≠">·àò·äï·çà·à≥·ãä ·â≥·à™·ä≠</option>
                        <option value="·å•·âÖ·àµ">·àò·äï·çà·à≥·ãä ·å•·âÖ·àµ</option>
                        <option value="·å•·ã´·âÑ">·å•·ã´·âÑ·äì ·àò·àç·àµ</option>
                    </select>
                    <textarea id="post-content" placeholder="·àÄ·à≥·â•·ãé·äï ·ä•·ãö·àÖ ·ã≠·åª·çâ..." class="w-full p-4 rounded-lg h-28 mb-3 text-black focus:ring-2 ring-gold outline-none"></textarea>
                    <button onclick="submitPost()" class="w-full bg-yellow-600 text-white py-3 rounded-xl font-bold hover:bg-yellow-500 shadow-lg transition">·ä†·åã·à´</button>
                </div>
                <div id="posts-feed" class="space-y-6"></div>
            </div>

            <!-- Tab: Admin -->
            <div id="tab-admin" class="hidden max-w-md mx-auto bg-white p-6 rounded-3xl text-black shadow-2xl shadow-black/50">
                <h2 class="font-bold text-xl mb-4 text-[#4a0404] border-b pb-2">·ã®·ä†·àµ·â∞·ã≥·ã≥·à™ ·çì·äê·àç</h2>
                
                <!-- Admin Internal Navigation -->
                <div class="flex gap-2 mb-6 bg-gray-100 p-1 rounded-lg">
                    <button onclick="switchAdminView('content')" id="sub-btn-content" class="flex-1 py-2 text-sm font-bold rounded-md bg-white text-[#4a0404] shadow-sm">·ã®·ãï·àà·âµ ·àò·à®·åÉ</button>
                    <button onclick="switchAdminView('users')" id="sub-btn-users" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500">·â∞·å†·âÉ·àö·ãé·âΩ</button>
                </div>

                <!-- Content Management View -->
                <div id="admin-view-content" class="space-y-4">
                    <div class="flex gap-2">
                        <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">·à≥·àù·äï·âµ</label><select id="adm-week" onchange="loadContentForEdit()" class="w-full p-3 border-2 border-gray-100 rounded-xl"></select></div>
                        <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">·âÄ·äï</label><select id="adm-day" onchange="loadContentForEdit()" class="w-full p-3 border-2 border-gray-100 rounded-xl">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option>
                        </select></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">YouTube ·àä·äï·ä≠</label><input type="text" id="adm-vid" class="w-full p-3 border-2 border-gray-100 rounded-xl"></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">·àù·àµ·â£·ä≠</label><textarea id="adm-misbak" class="w-full p-3 border-2 border-gray-100 rounded-xl h-20"></textarea></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">·âµ·àù·àÖ·à≠·âµ</label><textarea id="adm-gospel" class="w-full p-3 border-2 border-gray-100 rounded-xl h-24"></textarea></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">·â∞·åç·â£·à´·âµ (·â†·äÆ·àõ)</label><textarea id="adm-tasks" placeholder="·å∏·àé·âµ, ·àµ·åç·ã∞·âµ, ·äï·â£·â•" class="w-full p-3 border-2 border-gray-100 rounded-xl h-20"></textarea></div>
                    
                    <div class="flex gap-3 pt-2">
                        <button onclick="saveAdminData()" class="flex-1 bg-[#4a0404] text-white py-3 rounded-xl font-bold shadow-xl hover:bg-black transition">·ä†·àµ·âÄ·àù·å•</button>
                        <button onclick="deleteDailyContent()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold shadow-xl hover:bg-red-700 transition">·à∞·à≠·ãù</button>
                    </div>
                </div>

                <!-- User Management View -->
                <div id="admin-view-users" class="hidden space-y-4">
                    <div class="text-xs text-gray-500 font-bold mb-2 flex justify-between border-b pb-2">
                        <span>·àµ·àù</span>
                        <span>·ä¢·àú·ã≠·àç</span>
                        <span>·ä≠·à≠·àù</span>
                    </div>
                    <div id="users-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-1">
                        <!-- Users loaded here -->
                        <div class="text-center text-gray-400 py-4">Loading...</div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- CONTENT OVERLAY -->
    <div id="view-content" class="hidden fixed inset-0 bg-[#4a0404] z-[100] overflow-y-auto p-6">
        <div class="max-w-2xl mx-auto pb-20">
            <button onclick="closeContent()" class="text-4xl mb-6 hover:text-yellow-500 transition fixed top-4 right-4 z-20">‚úï</button>
            <h2 id="content-title" class="text-3xl font-bold mb-6 text-yellow-500 border-b border-yellow-900 pb-2 mt-8"></h2>
            <div id="content-video" class="aspect-video bg-black rounded-2xl overflow-hidden mb-6 shadow-2xl"></div>
            <div class="parchment p-6 rounded-r-2xl mb-6 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10 font-bold text-4xl">‚õ™</div>
                <span class="text-xs font-bold text-yellow-800 uppercase tracking-widest">·àù·àµ·â£·ä≠</span>
                <p id="content-misbak" class="text-xl italic font-bold mt-2 leading-relaxed"></p>
            </div>
            <div class="bg-black/20 p-6 rounded-2xl border border-yellow-900/30 mb-6">
                <span class="text-yellow-500 font-bold text-xs uppercase tracking-widest">·âµ·àù·àÖ·à≠·âµ</span>
                <p id="content-gospel" class="text-gray-200 leading-relaxed whitespace-pre-line mt-3"></p>
            </div>
            <div class="bg-white rounded-3xl p-6 text-[#4a0404] shadow-xl">
                <h4 class="font-bold text-lg mb-4 flex items-center gap-2">üìù ·ã®·ãõ·à¨ ·àò·äï·çà·à≥·ãä ·â∞·åç·â£·à´·âµ</h4>
                <div id="content-tasks-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-0kdjRqAfBVHU1mCEINGfUdLOfrb3G5Y",
            authDomain: "abiytsom-6c692.firebaseapp.com",
            projectId: "abiytsom-6c692",
            storageBucket: "abiytsom-6c692.firebasestorage.app",
            appId: "1:901800618361:web:a130df3ac314a3591367a8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const weeks = ["·ãò·ãà·à®·ã∞", "·âÖ·ãµ·àµ·âµ", "·àù·ä©·à´·â•", "·àò·åª·åâ·ãï", "·ã∞·â•·à® ·ãò·ã≠·âµ", "·åà·â•·à≠ ·äÑ·à≠", "·äí·âÜ·ã≤·àû·àµ", "·àÜ·à≥·ãï·äì"];
        const dayNames = ["·ä•·àÅ·ãµ", "·à∞·äû", "·àõ·ä≠·à∞·äû", "·à®·â°·ãï", "·àê·àô·àµ", "·ä†·à≠·â•", "·âÖ·ã≥·àú"];
        let currentUser = null;
        const ADMIN_EMAIL = "abiy389@gmail.com"; 

        // --- UI Utilities ---
        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'error' ? '‚ö†Ô∏è' : '‚úÖ';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        window.switchAuthTab = (tab) => {
            const loginForm = document.getElementById('form-login');
            const signupForm = document.getElementById('form-signup');
            const loginBtn = document.getElementById('tab-btn-login');
            const signupBtn = document.getElementById('tab-btn-signup');

            if (tab === 'login') {
                loginForm.classList.remove('hidden'); signupForm.classList.add('hidden');
                loginBtn.classList.replace('text-gray-400', 'bg-[#4a0404]'); loginBtn.classList.add('text-white');
                signupBtn.classList.remove('bg-[#4a0404]', 'text-white'); signupBtn.classList.add('text-gray-400');
            } else {
                signupForm.classList.remove('hidden'); loginForm.classList.add('hidden');
                signupBtn.classList.replace('text-gray-400', 'bg-[#4a0404]'); signupBtn.classList.add('text-white');
                loginBtn.classList.remove('bg-[#4a0404]', 'text-white'); loginBtn.classList.add('text-gray-400');
            }
        };

        // --- Auth Functions ---
        window.handleSignup = async () => {
            const email = document.getElementById('signup-email').value.trim();
            const pass = document.getElementById('signup-pass').value;
            const confirm = document.getElementById('signup-confirm-pass').value;
            const username = document.getElementById('signup-username').value.trim();

            if (!email || !pass || !username) return showToast("·ä•·â£·ä≠·ãé ·àÅ·àâ·àù ·ä†·àû·àå·ãé·âΩ·äï ·ã≠·àô·àâ", 'error');
            if (pass !== confirm) return showToast("·ã®·ã≠·àà·çç ·âÉ·àâ ·ä†·ã≠·ã∞·àù·àù·àù", 'error');
            if (pass.length < 6) return showToast("·ã®·ã≠·àà·çç ·âÉ·àç ·â¢·ã´·äï·àµ 6 ·çä·ã∞·àã·âµ ·àò·àÜ·äï ·ä†·àà·â†·âµ", 'error');

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(cred.user, { displayName: username });
                showToast("·àù·ãù·åç·â• ·â∞·à≥·ä≠·â∑·àç! ·ä•·â£·ä≠·ãé ·ã®·àö·âÄ·å•·àà·ãç·äï ·ã∞·à®·åÉ ·ã´·åç·äô");
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/email-already-in-use') return showToast("·ã≠·àÖ ·ä¢·àú·ã≠·àç ·âÄ·ãµ·àû ·â∞·àò·ãù·åç·âß·àç", 'error');
                showToast("·àù·ãù·åç·â• ·ä†·àç·â∞·à≥·ä´·àù: " + error.message, 'error');
            }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value.trim();
            const pass = document.getElementById('login-pass').value;
            if (!email || !pass) return showToast("·ä¢·àú·ã≠·àç ·ä•·äì ·ã®·ã≠·àà·çç ·âÉ·àç ·ã´·àµ·åà·â°", 'error');
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (error) {
                console.error(error);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') return showToast("·ã®·â∞·à≥·à≥·â∞ ·ä¢·àú·ã≠·àç ·ãà·ã≠·àù ·ã®·ã≠·àà·çç ·âÉ·àç", 'error');
                showToast("·àò·åç·â£·âµ ·ä†·àç·â∞·à≥·ä´·àù", 'error');
            }
        };

        window.handleProfileSetup = async () => {
            const name = document.getElementById('user-display-name').value.trim();
            if(!name) return showToast("·ä•·â£·ä≠·ãé ·àô·àâ ·àµ·àù·ãé·äï ·ã´·àµ·åà·â°", 'error');
            try {
                await updateProfile(currentUser, { displayName: name });
                await setDoc(doc(db, "users", currentUser.uid), { username: name, email: currentUser.email, uid: currentUser.uid, createdAt: new Date() }, { merge: true });
                showToast("·àò·åà·äì·äò·âµ ·â∞·à≥·ä≠·â∑·àç");
                initApp(currentUser);
            } catch (error) { console.error(error); showToast("·àµ·àô·äï ·àõ·àµ·âÄ·àò·å• ·ä†·àç·â∞·à≥·ä´·àù", 'error'); }
        };

        window.handleLogout = () => { signOut(auth).then(() => { location.reload(); }); };

        // --- App Logic ---
        function initApp(user) {
            currentUser = user;
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('display-user').textContent = "@" + user.displayName;
            
            const adminBtn = document.getElementById('btn-admin');
            const isAdmin = user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();

            if (isAdmin) {
                adminBtn.classList.remove('hidden'); adminBtn.style.display = 'block';
                // Load admin specific data
                loadUsersList(); 
            } else {
                adminBtn.classList.add('hidden'); adminBtn.style.display = 'none';
                switchTab('journey');
            }

            setDoc(doc(db, "users", user.uid), { email: user.email }, { merge: true });
            showWeeks();
            populateAdmin();
            loadPosts();
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if (!user.displayName) {
                    document.getElementById('auth-view').classList.add('hidden');
                    document.getElementById('setup-view').classList.remove('hidden');
                } else { initApp(user); }
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('setup-view').classList.add('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        // --- Navigation ---
        window.switchTab = (tab) => {
            const currentUserEmail = currentUser ? currentUser.email.toLowerCase() : "";
            if (tab === 'admin' && currentUserEmail !== ADMIN_EMAIL.toLowerCase()) {
                showToast("·ã≠·âÖ·à≠·â≥! ·ã≠·àÖ ·àµ·àç·âµ ·â†·ä†·ãµ·àö·äï ·â•·âª ·äê·ãç", 'error'); return;
            }
            ['journey', 'creative', 'admin'].forEach(t => {
                const view = document.getElementById('tab-' + t); const btn = document.getElementById('btn-' + t);
                if(view) view.classList.add('hidden'); if(btn) btn.className = "p-4 font-bold text-gray-400 text-sm";
            });
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('btn-' + tab).className = "p-4 font-bold tab-active text-sm";
        };

        window.switchAdminView = (view) => {
            document.getElementById('admin-view-content').classList.add('hidden');
            document.getElementById('admin-view-users').classList.add('hidden');
            document.getElementById('sub-btn-content').className = "flex-1 py-2 text-sm font-bold rounded-md text-gray-500";
            document.getElementById('sub-btn-users').className = "flex-1 py-2 text-sm font-bold rounded-md text-gray-500";
            
            if(view === 'content') {
                document.getElementById('admin-view-content').classList.remove('hidden');
                document.getElementById('sub-btn-content').className = "flex-1 py-2 text-sm font-bold rounded-md bg-white text-[#4a0404] shadow-sm";
            } else {
                document.getElementById('admin-view-users').classList.remove('hidden');
                document.getElementById('sub-btn-users').className = "flex-1 py-2 text-sm font-bold rounded-md bg-white text-[#4a0404] shadow-sm";
            }
        }

        // --- Journey ---
        window.showWeeks = () => {
            document.getElementById('view-weeks').classList.remove('hidden');
            document.getElementById('view-days').classList.add('hidden');
            const container = document.getElementById('weeks-container'); container.innerHTML = '';
            weeks.forEach((w, i) => {
                const isEven = i % 2 === 0;
                container.innerHTML += `
                    <div class="flex items-center w-full ${isEven ? 'flex-row' : 'flex-row-reverse'}">
                        <div class="w-1/2 flex justify-center"><div onclick="selectWeek('${w}')" class="node-btn"><span>${w}</span></div></div>
                        <div class="w-1/2 px-4 ${isEven ? 'text-left' : 'text-right'} text-yellow-500 font-bold text-[10px] uppercase">·à≥·àù·äï·âµ ${i+1}</div>
                    </div>`;
            });
        };

        window.selectWeek = (week) => {
            document.getElementById('view-weeks').classList.add('hidden');
            document.getElementById('view-days').classList.remove('hidden');
            const container = document.getElementById('days-container'); container.innerHTML = '';
            dayNames.forEach((d, i) => {
                const isEven = i % 2 === 0;
                container.innerHTML += `
                    <div class="flex items-center w-full ${isEven ? 'flex-row' : 'flex-row-reverse'}">
                        <div class="w-1/2 flex justify-center"><div onclick="openDay('${week}', ${i+1})" class="node-btn" style="width:70px;height:70px;font-size:11px">${d}</div></div>
                        <div class="w-1/2"></div>
                    </div>`;
            });
        };

        function extractVideoID(url) {
            const reg = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const m = url.match(reg);
            return (m && m[7].length == 11) ? m[7] : url;
        }

        window.openDay = async (week, day) => {
            const dayId = `${week}_${day}`;
            const snap = await getDoc(doc(db, "dailyContent", dayId));
            if (!snap.exists()) return showToast("·ã≠·âÖ·à≠·â≥! ·àà·ãõ·à¨ ·âÄ·äï ·ã®·â∞·ãò·åã·åÄ ·àò·à®·åÉ ·ã®·àà·àù·ç¢", 'error');
            const data = snap.data();
            document.getElementById('content-title').textContent = `${week} - ${dayNames[day-1]}`;
            document.getElementById('content-misbak').textContent = data.misbak;
            document.getElementById('content-gospel').textContent = data.gospel;
            document.getElementById('content-video').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${data.videoId}" frameborder="0" allowfullscreen></iframe>`;
            const taskContainer = document.getElementById('content-tasks-list'); taskContainer.innerHTML = '';
            const tasks = data.tasks || ["·å∏·àé·âµ", "·àµ·åç·ã∞·âµ", "·äï·â£·â•"];
            const progSnap = await getDoc(doc(db, `users/${currentUser.uid}/progress`, dayId));
            const completed = progSnap.exists() ? progSnap.data().completed || [] : [];
            tasks.forEach((task) => {
                const isChecked = completed.includes(task);
                taskContainer.innerHTML += `
                    <label class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                        <input type="checkbox" class="w-6 h-6 accent-[#4a0404]" ${isChecked ? 'checked' : ''} 
                            onchange="toggleTask('${dayId}', '${task}', this.checked)">
                        <span class="text-sm font-bold text-gray-700">${task}</span>
                    </label>`;
            });
            document.getElementById('view-content').classList.remove('hidden');
        };

        window.toggleTask = async (dayId, task, isChecked) => {
            const ref = doc(db, `users/${currentUser.uid}/progress`, dayId);
            if (isChecked) { await setDoc(ref, { completed: arrayUnion(task) }, { merge: true }); }
            else { await setDoc(ref, { completed: arrayRemove(task) }, { merge: true }); }
        };
        window.closeContent = () => document.getElementById('view-content').classList.add('hidden');

        // --- Creative Corner ---
        window.submitPost = async () => {
            const cat = document.getElementById('post-category').value;
            const content = document.getElementById('post-content').value;
            if(!content.trim()) return showToast("·àÄ·à≥·â• ·ã´·àµ·åà·â°", 'error');
            await addDoc(collection(db, "posts"), { username: currentUser.displayName, category: cat, content: content, likes: [], replies: [], createdAt: new Date() });
            document.getElementById('post-content').value = ''; showToast("·àÄ·à≥·â•·ãé ·â∞·àà·å•·çè·àç!");
        };

        window.deletePost = async (postId) => {
            if(confirm("·ã≠·àÖ·äï·äï ·àç·å•·çç ·â†·ã≠·çã ·àä·à∞·à≠·ãù ·ã≠·çà·àç·åã·àâ?")) {
                await deleteDoc(doc(db, "posts", postId));
                showToast("·àç·å•·çâ ·â∞·à∞·à≠·ãü·àç");
            }
        }

        window.loadPosts = () => {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const feed = document.getElementById('posts-feed'); feed.innerHTML = '';
                const isAdmin = currentUser && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                
                snap.forEach(d => {
                    const post = d.data(); const postId = d.id;
                    const liked = post.likes.includes(currentUser.uid);
                    
                    let repliesHtml = (post.replies || []).map(r => `
                        <div class="mt-3 p-3 bg-white/5 rounded-lg border-l-2 border-yellow-600 text-xs">
                            <span class="text-yellow-500 font-bold">${r.user}:</span> <span class="text-gray-300 ml-1">${r.text}</span>
                        </div>
                    `).join('');

                    // Admin Delete Button for Posts
                    const deleteBtn = isAdmin ? `<button onclick="deletePost('${postId}')" class="text-red-500 hover:text-red-400 ml-2 text-lg" title="·à∞·à≠·ãù">üóëÔ∏è</button>` : '';

                    feed.innerHTML += `
                        <div class="bg-black/30 p-5 rounded-3xl border border-white/5 shadow-xl">
                            <div class="flex justify-between items-center mb-4">
                                <span class="bg-yellow-600/20 text-yellow-500 text-[9px] px-3 py-1 rounded-full border border-yellow-600/30 font-bold uppercase">${post.category}</span>
                                <div class="flex items-center">
                                    <span class="text-[9px] text-gray-500">${new Date(post.createdAt.seconds*1000).toLocaleDateString('am-ET')}</span>
                                    ${deleteBtn}
                                </div>
                            </div>
                            <div class="text-yellow-500 font-bold text-sm mb-2">@${post.username}</div>
                            <p class="text-gray-100 whitespace-pre-line text-sm leading-relaxed mb-4">${post.content}</p>
                            <div class="flex gap-6 border-t border-white/5 pt-4">
                                <button onclick="toggleLike('${postId}', ${liked})" class="flex items-center gap-2 ${liked ? 'text-red-500' : 'text-gray-400'} hover:scale-110 transition">
                                    ${liked ? '‚ù§Ô∏è' : 'ü§ç'} <span class="text-xs font-bold">${post.likes.length}</span>
                                </button>
                                <button onclick="toggleReplyInput('${postId}')" class="text-gray-400 flex items-center gap-2 text-xs hover:text-white transition">üí¨ ·àò·àç·àµ ·àò·àµ·å´</button>
                            </div>
                            <div id="replies-${postId}">${repliesHtml}</div>
                            <div id="input-${postId}" class="hidden mt-4 flex gap-2">
                                <input id="field-${postId}" type="text" placeholder="·àò·àç·àµ·ãé·äï ·ä•·ãö·àÖ ·ã≠·åª·çâ..." class="flex-grow p-3 text-xs rounded-xl text-black">
                                <button onclick="sendReply('${postId}')" class="bg-yellow-600 px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition">·àã·ä≠</button>
                            </div>
                        </div>`;
                });
            });
        };

        window.toggleLike = async (postId, alreadyLiked) => {
            const ref = doc(db, "posts", postId);
            await updateDoc(ref, { likes: alreadyLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
        };
        window.toggleReplyInput = (id) => document.getElementById(`input-${id}`).classList.toggle('hidden');
        window.sendReply = async (postId) => {
            const text = document.getElementById(`field-${postId}`).value; if(!text.trim()) return;
            const ref = doc(db, "posts", postId);
            await updateDoc(ref, { replies: arrayUnion({ user: currentUser.displayName, text: text, at: new Date() }) });
            document.getElementById(`field-${postId}`).value = '';
        };

        // --- Admin Logic ---

        // 1. Populate Dropdowns
        function populateAdmin() {
            const sel = document.getElementById('adm-week');
            if(sel.options.length > 0) return;
            weeks.forEach(w => sel.add(new Option(w, w)));
        }

        // 2. Load Content for Editing (READ)
        window.loadContentForEdit = async () => {
            const w = document.getElementById('adm-week').value;
            const d = document.getElementById('adm-day').value;
            const dayId = `${w}_${d}`;
            const snap = await getDoc(doc(db, "dailyContent", dayId));
            if(snap.exists()) {
                const data = snap.data();
                document.getElementById('adm-vid').value = data.videoId || "";
                document.getElementById('adm-misbak').value = data.misbak || "";
                document.getElementById('adm-gospel').value = data.gospel || "";
                document.getElementById('adm-tasks').value = (data.tasks || []).join(", ");
            } else {
                // Clear fields if no data
                document.getElementById('adm-vid').value = "";
                document.getElementById('adm-misbak').value = "";
                document.getElementById('adm-gospel').value = "";
                document.getElementById('adm-tasks').value = "";
            }
        };

        // 3. Create/Update Content (CREATE/UPDATE)
        window.saveAdminData = async () => {
            const w = document.getElementById('adm-week').value;
            const d = document.getElementById('adm-day').value;
            const taskStr = document.getElementById('adm-tasks').value;
            const tasks = taskStr.split(',').map(t => t.trim()).filter(t => t !== "");
            await setDoc(doc(db, "dailyContent", `${w}_${d}`), {
                week: w, day: d, 
                videoId: extractVideoID(document.getElementById('adm-vid').value),
                misbak: document.getElementById('adm-misbak').value,
                gospel: document.getElementById('adm-gospel').value,
                tasks: tasks.length > 0 ? tasks : ["·å∏·àé·âµ", "·àµ·åç·ã∞·âµ", "·äï·â£·â•"]
            });
            showToast("·àò·à®·åÉ·ãç ·â†·â∞·à≥·ä´ ·àÅ·äî·â≥ ·â∞·àò·ãù·åç·âß·àç!");
        };

        // 4. Delete Content (DELETE)
        window.deleteDailyContent = async () => {
            const w = document.getElementById('adm-week').value;
            const d = document.getElementById('adm-day').value;
            const dayId = `${w}_${d}`;
            if(confirm(`·ä•·à≠·åç·å• ·ã® ${w} ·à≥·àù·äï·âµ ·âÄ·äï ${d} ·àò·à®·åÉ ·àõ·å•·çã·âµ ·ã≠·çà·àç·åã·àâ?`)) {
                await deleteDoc(doc(db, "dailyContent", dayId));
                showToast("·àò·à®·åÉ·ãç ·â∞·à∞·à≠·ãü·àç");
                // Clear form
                document.getElementById('adm-vid').value = "";
                document.getElementById('adm-misbak').value = "";
                document.getElementById('adm-gospel').value = "";
                document.getElementById('adm-tasks').value = "";
            }
        }

        // 5. Load Users (READ)
        window.loadUsersList = () => {
            const list = document.getElementById('users-list');
            const q = query(collection(db, "users"));
            onSnapshot(q, (snap) => {
                list.innerHTML = '';
                if(snap.empty) list.innerHTML = '<div class="text-center text-gray-400 py-4">·àù·äï·àù ·â∞·å†·âÉ·àö ·ã®·àà·àù</div>';
                snap.forEach(u => {
                    const user = u.data();
                    const uid = u.id;
                    list.innerHTML += `
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 flex justify-between items-center text-sm">
                            <div class="overflow-hidden">
                                <div class="font-bold text-gray-800 truncate">${user.username || 'No Name'}</div>
                                <div class="text-gray-500 text-xs truncate">${user.email}</div>
                            </div>
                            <button onclick="deleteUser('${uid}', '${user.username}')" class="text-red-500 hover:bg-red-100 p-2 rounded-lg transition" title="·â∞·å†·âÉ·àö·ãç·äï ·à∞·à≠·ãù">üóëÔ∏è</button>
                        </div>
                    `;
                });
            });
        };

        // 6. Delete User (DELETE)
        window.deleteUser = async (uid, name) => {
            // Note: This only deletes from Firestore. It does NOT revoke Auth access immediately.
            // But for the app logic, the user is effectively gone.
            if(confirm(`·ä•·à≠·åç·åù ${name} ·äï ·àà·ã®·ãò·àà·àà ·àõ·å•·çã·âµ ·ã≠·çà·àç·åã·àâ?`)) {
                await deleteDoc(doc(db, "users", uid));
                showToast("·â∞·å†·âÉ·àö·ãç ·â∞·à∞·à≠·ãü·àç");
            }
        }

    </script>
</body>
</html>